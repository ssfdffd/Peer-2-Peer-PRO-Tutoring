{
  "version": 3,
  "sources": ["../../../worker.js"],
  "sourceRoot": "C:\\Users\\Zanele\\Videos\\Peer-2-Peer Pro Tutoring\\.wrangler\\tmp\\deploy-QQO8Yj",
  "sourcesContent": ["// worker.js\r\n\r\n// --- 1. PASSWORD SECURITY (PBKDF2) ---\r\nasync function hashPassword(password) {\r\n  const encoder = new TextEncoder();\r\n  const salt = crypto.getRandomValues(new Uint8Array(16));\r\n  const keyMaterial = await crypto.subtle.importKey(\r\n    \"raw\", encoder.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\"]\r\n  );\r\n  const hashBuffer = await crypto.subtle.deriveBits(\r\n    { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\r\n    keyMaterial, 256\r\n  );\r\n  const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');\r\n  const hashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');\r\n  return `${saltHex}:${hashHex}`;\r\n}\r\n\r\nasync function verifyPassword(password, storedValue) {\r\n  try {\r\n    const [saltHex, originalHashHex] = storedValue.split(':');\r\n    const salt = new Uint8Array(saltHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));\r\n    const encoder = new TextEncoder();\r\n    const keyMaterial = await crypto.subtle.importKey(\r\n      \"raw\", encoder.encode(password), { name: \"PBKDF2\" }, false, [\"deriveBits\"]\r\n    );\r\n    const hashBuffer = await crypto.subtle.deriveBits(\r\n      { name: \"PBKDF2\", salt, iterations: 100000, hash: \"SHA-256\" },\r\n      keyMaterial, 256\r\n    );\r\n    const currentHashHex = Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');\r\n    return currentHashHex === originalHashHex;\r\n  } catch (e) {\r\n    return false; \r\n  }\r\n}\r\n\r\n// --- 2. PERMANENT JWT GENERATOR (NO EXPIRATION) ---\r\nasync function generateJWT(payload, secret) {\r\n  const header = { alg: \"HS256\", typ: \"JWT\" };\r\n  const encodedHeader = btoa(JSON.stringify(header));\r\n  \r\n  // No 'exp' field makes this token valid forever\r\n  const encodedPayload = btoa(JSON.stringify({\r\n    ...payload,\r\n    iat: Math.floor(Date.now() / 1000) \r\n  }));\r\n\r\n  const key = await crypto.subtle.importKey(\r\n    \"raw\", new TextEncoder().encode(secret),\r\n    { name: \"HMAC\", hash: \"SHA-256\" }, false, [\"sign\"]\r\n  );\r\n  const signature = await crypto.subtle.sign(\r\n    \"HMAC\", key, new TextEncoder().encode(`${encodedHeader}.${encodedPayload}`)\r\n  );\r\n  const encodedSignature = btoa(String.fromCharCode(...new Uint8Array(signature)))\r\n    .replace(/\\+/g, \"-\").replace(/\\//g, \"_\").replace(/=/g, \"\");\r\n    \r\n  return `${encodedHeader}.${encodedPayload}.${encodedSignature}`;\r\n}\r\n\r\n// --- 3. MAIN WORKER LOGIC ---\r\nexport default {\r\n  async fetch(request, env) {\r\n    const corsHeaders = {\r\n      \"Access-Control-Allow-Origin\": \"https://peer-2-peer.co.za\",\r\n      \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\r\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\"\r\n    };\r\n\r\n    if (request.method === \"OPTIONS\") return new Response(null, { headers: corsHeaders });\r\n\r\n    const url = new URL(request.url);\r\n    const secret = env.JWT_SECRET || \"default_secret_change_me\";\r\n\r\n    try {\r\n      // SIGNUP\r\n      if (url.pathname === \"/api/signup\" && request.method === \"POST\") {\r\n        const d = await request.json();\r\n        const secureHash = await hashPassword(d.password);\r\n\r\n        await env.DB.prepare(`\r\n          INSERT INTO users (\r\n            first_name, last_name, age, phone_number, backup_phone, \r\n            school_name, email, user_type, grade, school_code, \r\n            password_hash, data_consent_commercial\r\n          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)\r\n        `).bind(\r\n          d.firstName, d.lastName, parseInt(d.age), d.phone, d.backupPhone,\r\n          d.schoolName, d.email, d.userType, d.grade, d.schoolCode,\r\n          secureHash,\r\n          d.commercialConsent ? 1 : 0\r\n        ).run();\r\n\r\n        return new Response(JSON.stringify({ success: true }), { headers: corsHeaders });\r\n      }\r\n\r\n      // LOGIN\r\n      if (url.pathname === \"/api/login\" && request.method === \"POST\") {\r\n        const { email, password } = await request.json();\r\n        const user = await env.DB.prepare(\"SELECT * FROM users WHERE email = ?\").bind(email).first();\r\n\r\n        if (user && await verifyPassword(password, user.password_hash)) {\r\n          const token = await generateJWT({\r\n            id: user.id,\r\n            role: user.user_type, \r\n            email: user.email\r\n          }, secret);\r\n\r\n          return new Response(JSON.stringify({\r\n            success: true,\r\n            token,\r\n            role: user.user_type,\r\n            name: user.first_name\r\n          }), { headers: corsHeaders });\r\n        }\r\n    \r\n        return new Response(JSON.stringify({ error: \"Invalid email or password\" }), { status: 401, headers: corsHeaders });\r\n      }\r\n\r\n      // FORGOT PASSWORD\r\n      if (url.pathname === \"/api/forgot-password\" && request.method === \"POST\") {\r\n        const { email } = await request.json();\r\n        const user = await env.DB.prepare(\"SELECT id FROM users WHERE email = ?\").bind(email).first();\r\n\r\n        if (user) {\r\n          const resetToken = crypto.randomUUID();\r\n          await env.DB.prepare(\"UPDATE users SET reset_token = ? WHERE email = ?\").bind(resetToken, email).run();\r\n        }\r\n        return new Response(JSON.stringify({ success: true }), { headers: corsHeaders });\r\n      }\r\n\r\n    } catch (err) {\r\n      return new Response(JSON.stringify({ error: err.message }), { status: 500, headers: corsHeaders });\r\n    }\r\n\r\n    return new Response(\"Not Found\", { status: 404 });\r\n  }\r\n};"],
  "mappings": "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",
  "names": []
}
