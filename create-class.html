<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Live Class | Peer-2-Peer Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
        }

        .nav {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 5%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.3rem;
            font-weight: bold;
            background: linear-gradient(135deg, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .green {
            color: #32cd32;
            -webkit-text-fill-color: #32cd32;
        }

        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 5%;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #32cd32;
            box-shadow: 0 0 0 3px rgba(50, 205, 50, 0.2);
        }

        .btn {
            background: #32cd32;
            color: black;
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(50, 205, 50, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .class-list {
            margin-top: 1.5rem;
        }

        .class-item {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .class-item.active {
            border-left: 4px solid #32cd32;
        }

        .class-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .badge-live {
            background: rgba(50, 205, 50, 0.15);
            color: #32cd32;
            border: 1px solid rgba(50, 205, 50, 0.3);
        }

        .badge-scheduled {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .badge-completed {
            background: rgba(148, 163, 184, 0.15);
            color: #94a3b8;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }

        .badge-missed {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .room-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .class-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
            color: #94a3b8;
        }

        .class-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .start-btn {
            background: #32cd32;
            color: black;
        }

        .join-btn {
            background: #3b82f6;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #94a3b8;
        }

        .status-message {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="nav">
        <div class="logo">PEER-2-PEER <span class="green">PRO</span></div>
        <a href="tutor-portal.html" style="color: #94a3b8; text-decoration: none;">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>

    <div class="container">
        <!-- Left: Schedule Form -->
        <div class="card">
            <h2 style="margin-bottom: 2rem; display: flex; gap: 10px;">
                <i class="fas fa-video" style="color: #32cd32;"></i>
                Schedule <span style="color: #32cd32; margin-left: 5px;">Live Class</span>
            </h2>

            <div class="form-group">
                <label><i class="fas fa-user"></i> Your Name</label>
                <input type="text" id="tutorName" placeholder="e.g. Mr. Johnson">
            </div>

            <div class="form-group">
                <label><i class="fas fa-envelope"></i> Your Email</label>
                <input type="email" id="tutorEmail" placeholder="you@example.com">
            </div>

            <div class="form-group">
                <label><i class="fas fa-book"></i> Lesson Topic</label>
                <input type="text" id="topic" placeholder="e.g. Calculus Basics">
            </div>
            <div class="form-group">
                <label for="classSubject"><i class="fas fa-book"></i> Subject <span
                        style="color:#ef4444">*</span></label>
                <select id="classSubject" required style="
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid #ddd;
    background: white;
    font-size: 1rem;
    margin-top: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  ">
                    <option value="">-- Select Subject --</option>
                    <option value="accounting">Accounting</option>
                    <option value="afrikaans">Afrikaans</option>
                    <option value="agricultural management practices">Agricultural Management Practices</option>
                    <option value="agricultural science">Agricultural Science</option>
                    <option value="agricultural technology">Agricultural Technology</option>
                    <option value="business">Business Studies</option>
                    <option value="cat">CAT</option>
                    <option value="civil technology">Civil Technology</option>
                    <option value="computer applications technology">Computer Applications Technology</option>
                    <option value="consumer studies">Consumer Studies</option>
                    <option value="dance studies">Dance Studies</option>
                    <option value="design">Design</option>
                    <option value="development studies">Development Studies</option>
                    <option value="dramatic arts">Dramatic Arts</option>
                    <option value="economic and management sciences">Economic and Management Sciences</option>
                    <option value="economics">Economics</option>
                    <option value="electrical technology">Electrical Technology</option>
                    <option value="engineering graphics and design">Engineering Graphics and Design</option>
                    <option value="english">English</option>
                    <option value="equine studies">Equine Studies</option>
                    <option value="geography">Geography</option>
                    <option value="history">History</option>
                    <option value="hospitality studies">Hospitality Studies</option>
                    <option value="isindebele">IsiNdebele</option>
                    <option value="isixhosa">IsiXhosa</option>
                    <option value="isizulu">IsiZulu</option>
                    <option value="it">IT</option>
                    <option value="life orientation">Life Orientation</option>
                    <option value="life_science">Life Science</option>
                    <option value="marine sciences">Marine Sciences</option>
                    <option value="maritime economics">Maritime Economics</option>
                    <option value="mathematics">Mathematics</option>
                    <option value="math_lit">Math Lit</option>
                    <option value="mechanical technology">Mechanical Technology</option>
                    <option value="music">Music</option>
                    <option value="nautical science">Nautical Science</option>
                    <option value="physics">Physics</option>
                    <option value="religion studies">Religion Studies</option>
                    <option value="sepedi">Sepedi</option>
                    <option value="sesotho">Sesotho</option>
                    <option value="setswana">Setswana</option>
                    <option value="siswati">Siswati</option>
                    <option value="sport and exercise science">Sport and Exercise Science</option>
                    <option value="technical maths">Technical Maths</option>
                    <option value="technical sciences">Technical Sciences</option>
                    <option value="tourism">Tourism</option>
                    <option value="tshivenda">Tshivenda</option>
                    <option value="visual arts">Visual Arts</option>
                    <option value="xitsonga">Xitsonga</option>
                </select>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Date</label>
                    <input type="date" id="date">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Time</label>
                    <input type="time" id="time">
                </div>
            </div>

            <div class="form-group">
                <label><i class="fas fa-graduation-cap"></i> Grade</label>
                <select id="grade">
                    <option value="">Select Grade</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                    <option value="7">Grade 7</option>
                    <option value="8">Grade 8</option>
                    <option value="9">Grade 9</option>
                    <option value="10">Grade 10</option>
                    <option value="11">Grade 11</option>
                    <option value="12">Grade 12</option>
                </select>
            </div>

            <button class="btn" onclick="scheduleClass()" id="scheduleBtn">
                <i class="fas fa-calendar-plus"></i>
                Schedule Class
            </button>
        </div>

        <!-- Right: My Classes -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2><i class="fas fa-calendar-alt"></i> Your Classes</h2>
                <button onclick="refreshClasses()"
                    style="background: none; border: 1px solid rgba(50,205,50,0.3); color: #32cd32; padding: 8px 16px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>

            <div id="loadingStatus" class="status-message">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p style="margin-top: 1rem;">Loading your classes...</p>
            </div>

            <div id="classesContainer" class="class-list" style="display: none;"></div>

            <div id="emptyState" class="empty-state" style="display: none;">
                <i class="fas fa-calendar-plus" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <h3>No Classes Scheduled</h3>
                <p style="margin-top: 1rem;">Schedule your first class using the form!</p>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // TUTOR PAGE - WORKING VERSION
        // ============================================

        const API_BASE = "https://liveclass.buhle-1ce.workers.dev";
        let currentEmail = '';

        // ============================================
        // 1. SCHEDULE CLASS
        // ============================================
        async function scheduleClass() {
            const name = document.getElementById('tutorName').value.trim();
            const email = document.getElementById('tutorEmail').value.trim();
            const topic = document.getElementById('topic').value.trim();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const grade = document.getElementById('grade').value;

            if (!email || !topic || !date || !time) {
                alert('Please fill all required fields');
                return;
            }

            currentEmail = email;

            const btn = document.getElementById('scheduleBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Scheduling...';

            try {
                console.log('üì§ Scheduling class...', { email, topic, date, time });

                const response = await fetch(`${API_BASE}/api/schedule-class`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email,
                        name: name || email.split('@')[0],
                        topic,
                        grade: grade || 'Not Specified',
                        scheduled_date: date,
                        scheduled_time: time
                    })
                });

                const result = await response.json();
                console.log('üì• Schedule response:', result);

                if (result.success) {
                    alert(`‚úÖ Class Scheduled!\n\nRoom: ${result.roomName}\n\nLink: https://meet.jit.si/${result.roomName}`);

                    // Clear form
                    document.getElementById('topic').value = '';

                    // Save to session
                    sessionStorage.setItem('p2p_email', email);
                    sessionStorage.setItem('p2p_name', name);

                    // Reload classes
                    loadTutorClasses(email);
                } else {
                    alert('‚ùå Error: ' + (result.error || 'Failed to schedule'));
                }
            } catch (error) {
                console.error('Schedule error:', error);
                alert('‚ùå Network error. Check console.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-calendar-plus"></i> Schedule Class';
            }
        }

        // ============================================
        // 2. LOAD TUTOR CLASSES
        // ============================================
        async function loadTutorClasses(email) {
            const loading = document.getElementById('loadingStatus');
            const container = document.getElementById('classesContainer');
            const empty = document.getElementById('emptyState');

            loading.style.display = 'block';
            container.style.display = 'none';
            empty.style.display = 'none';

            try {
                console.log('üì§ Loading classes for:', email);

                const response = await fetch(`${API_BASE}/api/get-classes?email=${encodeURIComponent(email)}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const classes = await response.json();
                console.log('üì• Classes received:', classes);

                loading.style.display = 'none';

                if (!classes || classes.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                container.style.display = 'block';
                renderClasses(classes);

            } catch (error) {
                console.error('Load error:', error);
                loading.innerHTML = `
                    <i class="fas fa-exclamation-triangle" style="color: #ef4444; font-size: 2rem;"></i>
                    <p style="color: #ef4444; margin-top: 1rem;">Failed to load classes</p>
                    <button onclick="loadTutorClasses('${email}')" style="
                        background: #32cd32;
                        color: black;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 8px;
                        margin-top: 1rem;
                        cursor: pointer;
                        font-weight: bold;
                    ">
                        <i class="fas fa-redo"></i> Retry
                    </button>
                `;
            }
        }

        // ============================================
        // 3. RENDER CLASSES
        // ============================================
        function renderClasses(classes) {
            const container = document.getElementById('classesContainer');

            const sorted = [...classes].sort((a, b) => {
                const statusOrder = { 'active': 1, 'scheduled': 2, 'completed': 3 };
                return (statusOrder[a.status] || 4) - (statusOrder[b.status] || 4);
            });

            container.innerHTML = sorted.map(cls => {
                const isActive = cls.status === 'active';
                const isScheduled = cls.status === 'scheduled';
                const isCompleted = cls.status === 'completed';

                const classTime = new Date(`${cls.scheduled_date}T${cls.scheduled_time}`);
                const isPast = isScheduled && classTime < new Date();

                // Status badge
                let badge = '';
                if (isActive) badge = '<span class="badge badge-live"><i class="fas fa-broadcast-tower"></i> LIVE NOW</span>';
                else if (isCompleted) badge = '<span class="badge badge-completed"><i class="fas fa-check-circle"></i> COMPLETED</span>';
                else if (isPast) badge = '<span class="badge badge-missed"><i class="fas fa-clock"></i> MISSED</span>';
                else badge = '<span class="badge badge-scheduled"><i class="fas fa-calendar"></i> SCHEDULED</span>';

                // Action button
                let actionBtn = '';
                if (isActive) {
                    actionBtn = `<button onclick="joinClass('${cls.room_name}')" class="action-btn join-btn">
                        <i class="fas fa-sign-in-alt"></i> Join Class
                    </button>`;
                } else if (isScheduled) {
                    actionBtn = `<button onclick="startClass('${cls.room_name}', '${cls.tutor_email}')" class="action-btn start-btn">
                        <i class="fas fa-play"></i> ${isPast ? 'Start Late' : 'Start Live'}
                    </button>`;
                }

                return `
                <div class="class-item ${isActive ? 'active' : ''}">
                    <div class="class-header">
                        <h3 style="margin:0;">${escapeHtml(cls.topic || 'Untitled')}</h3>
                        ${badge}
                    </div>
                    
                    <div class="room-info">
                        <span><i class="fas fa-door-open"></i> ${cls.room_name}</span>
                        <button onclick="copyLink('${cls.room_name}')" class="copy-btn">
                            <i class="fas fa-copy"></i> Copy Link
                        </button>
                    </div>
                    
                    <div class="class-details">
                        <div><i class="fas fa-graduation-cap"></i> Grade ${cls.grade || 'N/A'}</div>
                        <div><i class="fas fa-calendar"></i> ${formatDate(cls.scheduled_date)}</div>
                        <div><i class="fas fa-clock"></i> ${formatTime(cls.scheduled_time)}</div>
                    </div>
                    
                    <div class="class-footer">
                        <span style="color: #94a3b8;">
                            <i class="fas fa-chalkboard-teacher"></i> ${escapeHtml(cls.tutor_name || 'Tutor')}
                        </span>
                        ${actionBtn}
                    </div>
                </div>
                `;
            }).join('');
        }

        // ============================================
        // 4. START CLASS
        // ============================================
        async function startClass(roomName, email) {
            if (!confirm('Start this live class?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/go-live`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, roomName })
                });

                const result = await response.json();

                if (result.success) {
                    window.open(`https://meet.jit.si/${roomName}`, '_blank');
                    setTimeout(() => loadTutorClasses(email), 2000);
                } else {
                    alert('Failed to start: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Network error');
                console.error(error);
            }
        }

        // ============================================
        // 5. JOIN CLASS
        // ============================================
        function joinClass(roomName) {
            window.open(`https://meet.jit.si/${roomName}`, '_blank');
        }

        // ============================================
        // 6. COPY LINK
        // ============================================
        function copyLink(roomName) {
            const link = `https://meet.jit.si/${roomName}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('‚úÖ Link copied!');
            });
        }

        // ============================================
        // 7. REFRESH
        // ============================================
        function refreshClasses() {
            if (currentEmail) {
                loadTutorClasses(currentEmail);
            }
        }

        // ============================================
        // 8. HELPER FUNCTIONS
        // ============================================
        function formatDate(date) {
            if (!date) return 'TBD';
            const d = new Date(date);
            if (isNaN(d.getTime())) return date;
            const today = new Date();
            if (d.toDateString() === today.toDateString()) return 'Today';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function formatTime(time) {
            if (!time) return 'TBD';
            if (time.includes(':')) {
                const [h, m] = time.split(':');
                const hour = parseInt(h);
                return `${hour % 12 || 12}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
            }
            return time;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // 9. INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ Tutor page loaded');

            // Set default date/time
            const today = new Date();
            document.getElementById('date').value = today.toISOString().split('T')[0];

            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            document.getElementById('time').value = `${nextHour.getHours().toString().padStart(2, '0')}:00`;

            // Load saved email
            const savedEmail = sessionStorage.getItem('p2p_email');
            const savedName = sessionStorage.getItem('p2p_name');

            if (savedEmail) {
                document.getElementById('tutorEmail').value = savedEmail;
                document.getElementById('tutorName').value = savedName || '';
                currentEmail = savedEmail;
                loadTutorClasses(savedEmail);
            }

            // Auto refresh
            setInterval(() => {
                if (currentEmail && !document.hidden) {
                    loadTutorClasses(currentEmail);
                }
            }, 30000);
        });

        // Make functions global
        window.scheduleClass = scheduleClass;
        window.loadTutorClasses = loadTutorClasses;
        window.startClass = startClass;
        window.joinClass = joinClass;
        window.copyLink = copyLink;
        window.refreshClasses = refreshClasses;
    </script>
</body>

</html>