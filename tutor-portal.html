<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tutor Portal | Peer-2-Peer Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="tutor.css">
    <script src='https://meet.jit.si/external_api.js'></script>
</head>

<body>

    <nav class="glass-nav">
        <div class="nav-left">
            <div class="logo-pill">P2P PRO</div>
        </div>
        <div class="nav-right">
            <div class="user-profile">
                <div class="avatar"><i class="fas fa-user-tie"></i></div>
                <span id="tutorNameDisplay">Loading Tutor...</span>
            </div>
            <button class="logout-minimal" onclick="logout()">
                <i class="fas fa-power-off"></i>
            </button>
        </div>
    </nav>

    <main class="main-panel">
        <div id="mainDashboard">
            <header class="panel-header">
                <h1>Tutor <span style="color: var(--green);">Hub</span></h1>
                <p>Strategic management of your academic sessions and resources.</p>
            </header>

            <div class="dashboard-grid">
                <div class="dash-card card-featured" onclick="showSection('liveOrganizer')">
                    <div class="card-icon"><i class="fas fa-video"></i></div>
                    <h3>Live Class Organiser</h3>
                    <p>Schedule and launch secure Jitsi video lessons with students.</p>
                    <div class="card-status"><i class="fas fa-circle"></i> System Ready</div>
                </div>

                <div class="dash-card" onclick="showSection('resourceSharing')">
                    <div class="card-icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <h3>Resources</h3>
                    <p>Distribute study guides and notes.</p>
                </div>

                <div class="dash-card" onclick="showSection('tutorDashboard')">
                    <div class="card-icon"><i class="fas fa-chart-pie"></i></div>
                    <h3>Performance</h3>
                    <p>View student analytics.</p>
                </div>

                <div class="dash-card" onclick="showSection('p2pForum')">
                    <div class="card-icon"><i class="fas fa-comments"></i></div>
                    <h3>P2P Forum</h3>
                    <p>Join community discussions.</p>
                </div>

                <div class="dash-card card-wide" onclick="alert('Digital Whiteboard launching soon!')">
                    <div class="card-icon"><i class="fas fa-chalkboard"></i></div>
                    <div class="card-content">
                        <h3>Interactive Whiteboard</h3>
                        <p>Collaborate in real-time using our canvas drawing tools.</p>
                    </div>
                </div>
            </div>
        </div>

        <section id="liveOrganizer" class="portal-section" style="display: none;">
            <div class="section-header-row">
                <button class="btn-back" onclick="backToDash()"><i class="fas fa-chevron-left"></i> Back</button>
                <h2>Class <span style="color: var(--green);">Organiser</span></h2>
            </div>

            <div id="live-setup-section" class="glass-form-container">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Lesson Topic</label>
                        <input type="text" id="classTopic" placeholder="e.g. Physics: Newton's Laws">
                    </div>
                    <div class="form-group">
                        <label>Target Grade</label>
                        <select id="classGrade">
                            <option>Grade 8</option>
                            <option>Grade 9</option>
                            <option>Grade 10</option>
                            <option>Grade 11</option>
                            <option>Grade 12</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Brief Description</label>
                    <textarea id="classDesc" placeholder="What will be covered in this session?"></textarea>
                </div>
                <button class="btn-deploy" onclick="scheduleClass()">
                    <i class="fas fa-calendar-check"></i> Save & Schedule
                </button>

                <div class="scheduled-list">
                    <h3>Your Upcoming Sessions</h3>
                    <div id="myMeetingsList" class="meeting-grid">
                    </div>
                </div>
            </div>

            <div id="video-area" class="video-container"></div>
        </section>
    </main>

    <script src="tutor.js"></script>
    <script>
        const API_BASE = "https://damp-art-617fp2p-authentification-login.buhle-1ce.workers.dev"; // AUTH
        const API_BASE2 = "https://p2p-live-worker.buhle-1ce.workers.dev"; // LIVE CLASS

        function checkTutorSession() {
            const email = sessionStorage.getItem('p2p_email');
            const userType = sessionStorage.getItem('p2p_userType');
            if (!email || userType !== 'tutor') {
                window.location.href = "login.html";
                return;
            }
            document.getElementById('tutorNameDisplay').innerText = sessionStorage.getItem('p2p_name') || "Tutor";
        }

        // Layout Switching
        function showSection(sectionId) {
            document.getElementById('mainDashboard').style.display = 'none';
            document.querySelectorAll('.portal-section').forEach(s => s.style.display = 'none');

            const target = document.getElementById(sectionId);
            if (target) {
                target.style.display = 'block';
                if (sectionId === 'liveOrganizer') loadMyMeetings();
            }
        }

        function backToDash() {
            document.querySelectorAll('.portal-section').forEach(s => s.style.display = 'none');
            document.getElementById('mainDashboard').style.display = 'block';
            document.getElementById('video-area').style.display = 'none';
            document.getElementById('live-setup-section').style.display = 'block';
        }

        // Logic for Scheduling
        async function scheduleClass() {
            const topic = document.getElementById('classTopic').value.trim();
            const grade = document.getElementById('classGrade').value;
            const desc = document.getElementById('classDesc').value.trim();
            const email = sessionStorage.getItem('p2p_email');

            if (!topic || !desc) return alert("Fill in topic and description.");

            try {
                const response = await fetch(`${API_BASE2}/api/schedule-class`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, topic, description: desc, grade })
                });
                const result = await response.json();
                if (result.success) {
                    alert("Session Locked in!");
                    loadMyMeetings();
                }
            } catch (e) { alert("Connectivity error with Live Worker."); }
        }

        async function loadMyMeetings() {
            const email = sessionStorage.getItem('p2p_email');
            const container = document.getElementById('myMeetingsList');

            try {
                const res = await fetch(`${API_BASE2}/api/get-classes?email=${email}`);
                const classes = await res.json();

                container.innerHTML = classes.map(c => `
            <div class="meeting-item">
                <div class="meeting-info">
                    <strong>${c.topic}</strong>
                    <span>Grade ${c.grade} â€¢ ${new Date(c.created_at).toLocaleDateString()}</span>
                </div>
                <button class="btn-start" onclick="goLive(${c.id})">Start</button>
            </div>
        `).join('') || "<p>No sessions scheduled.</p>";
            } catch (e) { container.innerHTML = "Error syncing meetings."; }
        }

        async function goLive(classId) {
            const email = sessionStorage.getItem('p2p_email');
            try {
                const res = await fetch(`${API_BASE2}/api/go-live`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, classId })
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('live-setup-section').style.display = 'none';
                    const videoArea = document.getElementById('video-area');
                    videoArea.style.display = 'block';

                    new JitsiMeetExternalAPI("meet.jit.si", {
                        roomName: result.roomName,
                        width: '100%',
                        height: 600,
                        parentNode: videoArea,
                        userInfo: { displayName: sessionStorage.getItem('p2p_name') }
                    });
                }
            } catch (e) { alert("Live bridge failed."); }
        }

        function logout() {
            sessionStorage.clear();
            window.location.href = "login.html";
        }

        document.addEventListener('DOMContentLoaded', checkTutorSession);
    </script>
</body>

</html>